;-----INT 14-------------------------------------------------------------
; RS232_IO
;       ότα πςοηςαννα οβσμυφιχαετ RS232
;
;   00H ΙΞΙΓΙΑΜΙΪΙΟΧΑΤΨ ΛΟΝΝΥΞΙΛΑΓΙΟΞΞΩΚ ΠΟΤ
;     χΘΟΔ: DX = ΞΟΝΕ ΠΟΤΑ (0-1)
;           AL = ΒΙΤΟΧΩΕ ΖΜΑΗΙ ΠΑΑΝΕΤΑ ΙΞΙΓΙΑΜΙΪΑΓΙΙ:
;           ‚€7€€6€€5€€4€€3€€€2€€€1€€0€ƒ
;            -- ΒΟΔ -- ήΕΤΞΟΣΤΨΣΤΟΠΔΜΙΞΑ  
;           „€€€‰€€€‰€€€‰€€€‰€€€€‰€·€€‰€€€‰€€€…
;            «    Έ    ®  « Έ ®    ΅   «   »   ΔΜΙΞΑ ΣΜΟΧΑ
;                 ΅         ΅      ΅           10=7 ΒΙΤ; 11=8 ΒΙΤ
;                 ΅         ΅      «          ΣΤΟΠ-ΒΙΤ: 0=1; 1=2;
;                 ΅         «                 ΛΟΔ ήΕΤΞΟΣΤΙ
;                 ΅                            x0=ΞΕΤ; 01=ΞΕήΕΤ; 11=ήΕΤ
;                 «                           ΒΟΔ:       000=110; 100=1200
;                                                         001=150; 101=2400
;                                                         010=300; 110=4800
;                                                         011=600; 111=9600
;    χΩΘΟΔ: AH = ΣΤΑΤΥΣ ΛΟΝΝΥΞΙΛΑΓΙΚ (ΣΝ. ΞΙΦΕ)
;
;‹‹‹ ‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹
;   01H ΠΟΣΜΑΤΨ ΣΙΝΧΟΜ ήΕΕΪ ΧΩΒΑΞΞΩΚ ΠΟΤ RS-232
;     χΘΟΔ: DX = ΞΟΝΕ ΠΟΤΑ (0-1)
;           AL = ΠΟΣΩΜΑΕΝΩΚ ΣΙΝΧΟΜ
;    χΩΘΟΔ: AL ΣΟΘΑΞΕΞ.
;           εΣΜΙ ΥΣΤΑΞΟΧΜΕΞ ΒΙΤ 7 Χ AH, ΤΟ ΠΟΙΪΟΫΜΑ ΟΫΙΒΛΑ, Ι
;              AH (ΒΙΤΩ 6-0) = ΣΤΑΤΥΣ ΜΙΞΙΙ ΣΧΡΪΙ (ΣΝ. AH ΞΙΦΕ)
;‹‹‹ ‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹
;    02H ΠΟΜΥήΙΤΨ ΣΙΝΧΟΜ ήΕΕΪ ΧΩΒΑΞΞΩΚ ΠΟΤ RS-232
;     χΘΟΔ: DX = ΞΟΝΕ ΠΟΤΑ (0-1)
;    χΩΘΟΔ: AL = ΠΟΜΥήΕΞΞΩΚ ΣΙΝΧΟΜ
;           AH ΞΕΞΥΜΕΧΟΚ, ΕΣΜΙ ΠΟΙΪΟΫΜΑ ΟΫΙΒΛΑ
;‹‹‹ ‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹
;    03H ΔΑΤΨ ΣΤΑΤΥΣ ΠΟΤΑ ΣΧΡΪΙ
;     χΘΟΔ: DX = ΞΟΝΕ ΠΟΤΑ (0-1)
;    χΩΘΟΔ: AX = ΣΤΑΤΥΣ ΠΟΤΑ ΣΧΡΪΙ
;           AH = ΣΤΑΤΥΣ ΜΙΞΙΙ
;           ‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹
;           bit 7: TIME OUT όΤΟΤ ΒΙΤ ΙΣΠΟΜΨΪΥΕΤΣΡ, ΕΣΜΙ ΣΙΝΧΟΜ ΞΕ ΒΩΜ ΟΤΠΑΧΜΕΞ
;			    ΙΜΙ ΠΙΞΡΤ Χ ΪΑΔΑΞΞΟΕ ΧΕΝΡ. χ άΤΟΝ ΣΜΥήΑΕ ΧΣΕ ΟΣ-
;			    ΤΑΜΨΞΩΕ ΒΙΤΩ ΣΟΣΤΟΡΞΙΡ ΜΙΞΙΙ Ι ΝΟΔΕΝΑ ΞΕ ΙΝΕΐΤ ΪΞΑ-
;			    ήΕΞΙΡ.
;           bit 6: πΕΕΔΑΤήΙΛ ΠΥΣΤ (ΧΣΕ ΣΙΝΧΟΜΩ ΠΕΕΔΑΞΩ).
;           bit 5: πΕΕΔΑΐέΙΚ ΒΥΖΕ ΠΥΣΤ.
;           bit 4: οΒΞΑΥΦΕΞΑ ΠΟΣΜΕΔΟΧΑΤΕΜΨΞΟΣΤΨ BREAK.
;           bit 3: τΙΠΟΧΑΡ ΟΫΙΒΛΑ, ΞΑΠΙΝΕ ΞΕΠΑΧΙΜΨΞΩΚ ΒΙΤ ΟΣΤΑΞΟΧΑ.
;           bit 2: οΫΙΒΛΑ Χ ήΕΤΞΟΣΤΙ.
;           bit 1: πΕΕΠΟΜΞΕΞΙΕ ΠΙΕΝΞΙΛΑ.
;           bit 0: δΑΞΞΩΕ ΠΙΕΝΑ ΠΙΣΥΤΣΤΧΥΐΤ.
;€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€
;
;           AL = ΣΤΑΤΥΣ ΝΟΔΕΝΑ
;	    ‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹
;   	    bit 7: ΠΙΕΝΞΑΡ ΜΙΞΙΡ ΠΟΜΥήΙΜΑ ΣΙΗΞΑΜ.
;   	    bit 6: ΛΟΜΨΓΕΧΟΚ ΙΞΔΙΛΑΤΟ.
;   	    bit 5: ΞΑΒΟ ΔΑΞΞΩΘ ΟΒΞΑΥΦΕΞ.
;   	    bit 4: ΟήΙΣΤΛΑ ΠΕΕΣΩΜΛΙ.
;   	    bit 3: ΠΙΕΝ ΔΑΞΞΩΘ.
;   	    bit 2: ΛΟΞΕΓ ΔΑΞΞΩΘ ΧΩΔΕΜΕΞ.
;   	    bit 1: ΞΑΒΟ ΔΑΞΞΩ ΠΟήΙΤΑΞ.
;   	    bit 0: ΟήΙΣΤΛΑ ΟΤΠΑΧΜΕΞΑ.
;
;-----------------------------------------------------------------------------
;
;	COM1 Ι COM2 ΙΞΙΓΙΑΜΙΪΙΥΕΤ BIOS.
;       ΠΙ ΙΞΙΓΙΑΜΙΪΑΓΙΙ ΪΑΠΟΜΞΡΐΤΣΡ ΣΜΕΔΥΐέΙΕ ΡήΕΚΛΙ
;
;     0:400  RS232_BASE[0]  DW  3F8H - ΑΔΕΣ ΕΗΙΣΤΑ ΔΑΞΞΩΘ ΠΕΕΔΑΤήΙΛΑ COM1.
;     0:402  RS232_BASE[2]  DW  2F8H - ΑΔΕΣ ΕΗΙΣΤΑ ΔΑΞΞΩΘ ΠΕΕΔΑΤήΙΛΑ COM2.
;
;     0:47C  RS232_TIM_OUT[0]  DB  01 - χΕΝΡ ΟΦΙΔΑΞΙΡ ΠΙΘΟΔΑ ΣΙΝΧΟΜΑ ΔΜΡ COM1.
;			               πΙ ΞΕΟΒΘΟΔΙΝΟΣΤΙ ΝΟΦΞΟ ΠΟΣΤΑΧΙΤΨ ΔΥΗΟΕ.
;     0:47D  RS232_TIM_OUT[1]  DB  01
;     0:47E  RS232_TIM_OUT[2]  DB  01
;     0:47F  RS232_TIM_OUT[3]  DB  01
;
;     δΜΡ ΙΞΙΓΙΑΜΙΪΑΓΙΙ COM3 Ι COM4 ΞΕΟΒΘΟΔΙΝΟ ΪΑΠΙΣΑΤΨ ΑΔΕΣ Χ
;
;     0:404  RS232_BASE[4]  DW  ?
;     0:406  RS232_BASE[6]  DW  ?
;
;     Ι ΙΣΠΟΜΨΪΟΧΑΤΨ ΖΥΞΛΓΙΐ  AH = 0
;-----------------------------------------------------------------------------

        ASSUME  CS:CODE,DS:DATA
        ORG     0E729H
A1      LABEL   WORD            ; ταβμιγα ϊξαώεξικ δμρ ιξιγιαμιϊαγιι
        DW      1047            ; 110 βοδ
        DW      768             ; 150
        DW      384             ; 300
        DW      192             ; 600
        DW      96              ; 1200
        DW      48              ; 2400
        DW      24              ; 4800
        DW      12              ; 9600

RS232_IO        PROC    FAR

;-----  χθοδ χ πςεςωχαξιε

        STI
        PUSH    DS
        PUSH    DX
        PUSH    SI
        PUSH    DI
        PUSH    CX
        PUSH    BX
        MOV     SI,DX                   ; χ SI ξονες COM ποςτα ισπομψϊυετσρ
					; δμρ αδςεσαγιι λ ρώεκλαν RS232_BASE
        MOV     DI,DX                   ; DI ισπομψϊυετσρ δμρ αδςεσαγιι λ
					; RS232_TIM_OUT
        SHL     SI,1
        CALL    DDS
        MOV     DX,RS232_BASE[SI]       ; πομυώεξιε βαϊοχοηο αδςεσα
        OR      DX,DX                   ; τεστ ξε ιξιγιαμιϊιςοχαξξοηο ποςτα
        JZ      A3                      ; χοϊχςατ
        OR      AH,AH                   ; τεστ δμρ (AH)=0
        JZ      A4                      ; ιξιγιαμιϊαγιρ
        DEC     AH                      ; τεστ δμρ (AH)=1
        JZ      A5                      ; πεςεσωμλα AL
        DEC     AH                      ; τεστ δμρ (AH)=2
        JZ      A12                     ; ώτεξιε χ AL
A2:
        DEC     AH                      ; τεστ δμρ (AH)=3
        JNZ     A3
        JMP     A18                     ; πομυώεξιε στατυσα
A3:                                     ; χωθοδ
        POP     BX
        POP     CX
        POP     DI
        POP     SI
        POP     DX
        POP     DS
        IRET

;-----  ιξικιαμιϊαγιρ

A4:
        MOV     AH,AL                   ; παςανετςω ιξιγιαμιϊαγιι χ AH
        ADD     DX,3                    ; χ DX - 3FBH (2FBH) αδςεσ ςεηιστςα
					; υπςαχμεξιρ μιξιεκ LCR
        MOV     AL,80H
        OUT     DX,AL                   ; υσταξοχλα DLAB=1 δμρ πομυώεξιρ δοσ-
					; τυπα λ ζιλσατοςαν δεμιτεμρ

;-----  οπςεδεμεξιε σλοςοστι πεςεδαώι

        MOV     DL,AH                   ; χωδεμεξιε ιϊ βακτα ιξιγιαμιϊαγιι
        MOV     CL,4                    ; σλοςοστι πεςεδαώι.
        ROL     DL,CL                   ;
        AND     DX,0EH                  ;
        MOV     DI,OFFSET A1            ;  πομυώεξιε σνεύεξιρ ταβμιγω δεμιτεμρ.
        ADD     DI,DX                   ;
        MOV     DX,RS232_BASE[SI]       ;  πομυώεξιε βαϊοχοηο αδςεσα
        INC     DX                      ;  αδςεσ σταςϋεηο βακτα ςεηιστςα δεμιτ.
        MOV     AL,CS:[DI]+1            ;  πομυώεξιε χεμιώιξω δεμιτεμρ
        OUT     DX,AL                   ;  ϊαπισψ σταςϋεηο βακτα
        DEC     DX
        MOV     AL,CS:[DI]              ;
        OUT     DX,AL                   ;  ϊαπισψ νμαδϋεηο βακτα
        ADD     DX,3                    ;  ςεηιστς υπςαχμεξιρ νοδενον
        MOV     AL,AH                   ;  παςανετςω
        AND     AL,01FH                 ;  οβξυμεξιε 7,6 ι 5 βιτ
        OUT     DX,AL                   ;  ϊαπισψ παςανετςοχ
        DEC     DX
        DEC     DX                      ; ςεηιστς ιδεξτιζιλαγιι πςεςωχαξικ
        MOV     AL,0
        OUT     DX,AL                   ; χσε πςεςωχαξιρ χωλμΰώεξω
        JMP     SHORT A18               ; COM_STATUS

;-----  πεςεσωμλα σινχομα AH = 1

A5:
        PUSH    AX
        ADD     DX,4                    ; ςεηιστς υπςαχμεξιρ νοδενον
        MOV     AL,3                    ; χωθοδ DTR ι RTC χ αλτιχξον σοστορξιι
        OUT     DX,AL
        INC     DX                      ; ςεηιστς σοστορξιρ νοδενα
        INC     DX
        MOV     BH,30H                  ; οώιστλα δμρ πεςεδαώι ι ηοτοχξοστψ
					; πεςεδαώι
        CALL    WAIT_FOR_STATUS         ; οφιδαξιε
        JE      A9                      ; δα, πεςεδαώα σινχομα
A7:
        POP     CX
        MOV     AL,CL                   ; πεςεϊαηςυϊλα βακτα δαξξωθ
A8:
        OR      AH,80H                  ; ιξδιλαγιρ TIME OUT
        JMP     A3                      ; χωθοδ
A9:                                     ; CLEAR_TO_SEND
        DEC     DX                      ; ςεηιστς σοστορξιρ μιξιι
A10:                                    ; WAIT_SEND
        MOV     BH,20H                  ; ςεηιστς δαξξωθ πεςεδατώιλα πυστ
        CALL    WAIT_FOR_STATUS                                          
        JNZ     A7                      ; χοϊχςατ σ υσταξοχμεξξων TIME OUT 
A11:                                    ; OUT_CHAR
        SUB     DX,5                    ; ποςτ δαξξωθ
        POP     CX                      ; χοϊχςαύεξιε δαξξωθ
        MOV     AL,CL                   ; 
        OUT     DX,AL                   ; χωχοδ σινχομα
        JMP     A3                      ; χωθοδ

;-----  ώτεξιε AH = 2

A12:
        ADD     DX,4                    ; ςεηιστς υπςαχμεξιρ νοδενον
        MOV     AL,1                    ; πεςεχοδ DTR χ αλτιχξοε σοστορξιε
        OUT     DX,AL
        INC     DX                      ; ςεηιστς σοστορξιρ νοδενα        
        INC     DX
A13:                                    ; WAIT_DSR
        MOV     BH,20H                  ; ηοτοχξοστψ λ πεςεδαώι δαξξωθ
        CALL    WAIT_FOR_STATUS         ;                             
        JNZ     A8                      ; χοϊχςατ σ οϋιβλοκ
A15:                                    ; WAIT_DSR_END
        DEC     DX                      ; ςεηιστς σοστορξιρ μιξιι
A16:                                    ; WAIT_RECV
        MOV     BH,1                    ; ιξδιλατος ηοτοχξοστι δαξξωθ χ πςιενξιλε
        CALL    WAIT_FOR_STATUS         ;                         
        JNZ     A8                      ; TIME OUT οϋιβλα   
A17:                                    ; GET_CHAR
        AND     AL,00011110B            ; τεστ οϋιβοώξοηο σοστορξιρ               
        MOV     DX,RS232_BASE[SI]       ; ποςτ δαξξωθ
        IN      AL,DX                   ; ώτεξιε σινχομα         
        JMP     A3                      ; χωθοδ      

;-----  στατυσ AH = 3            

A18:
        MOV     DX,RS232_BASE[SI]
        ADD     DX,5                    ; ςεηιστς σοστορξιρ μιξιι
        IN      AL,DX                   ;                        
        MOV     AH,AL                   ; πεςεχοδ χ AH δμρ χοϊχςατα
        INC     DX                      ; ςεηιστς σοστορξιρ νοδενα      
        IN      AL,DX                   ; 
        JMP     A3                      ; χοϊχςατ
;----------------------------------------
; οφιδαξιε δμρ πομυώεξιρ σοστορξιρ      :
;                                       :
; χθοδ :                                :
;       BH=νασλα                        :
;       DX=αδςεσ ςεηιστςα στατυσα       :
; χωθοδ:                                 :
;       ZF υσταξοχμεξ = χςενρ χωϋμο     :
;       AH=στατυσ                       :
;----------------------------------------
WAIT_FOR_STATUS PROC    NEAR
        MOV     BL,RS232_TIM_OUT[DI]    ; ώτεξιε σώετώιλα
WFS0:
        SUB     CX,CX
WFS1:
        IN      AL,DX                   ; πομυώεξιε σταυσα
        MOV     AH,AL                   ; σοθςαξεξιε χ AH
        AND     AL,BH                   ; χωδιμεξιε βιτοχ δμρ τεστα
        CMP     AL,BH                   ; σςαχξεξιε σ νασλοκ
        JE      WFS_END                 ; χωθοδ σ σβςοϋεξξων ZF
        LOOP    WFS1                    ; ποχτοςιτψ σξοχα
        DEC     BL
        JNZ     WFS0

        OR      BH,BH                   ; υσταξοχιτψ ZF
WFS_END:
        RET
WAIT_FOR_STATUS ENDP
RS232_IO        ENDP

;F3D     DB      'ERROR. (RESUME = F1 KEY)',13,10        ; ERROR PROMPT

