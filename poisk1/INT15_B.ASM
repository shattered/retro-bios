;-------------------------------------------------------------------------- 
WRITE_BYTE	PROC	NEAR 
; תבניףר גבךפב מב כבףףופץ 
; גגבךפ הלס תבניףי נועוהבופףס ק עוחיףפעו AL. 
;--------------------------------------------------------------------------- 
	PUSH	CX			;ףןטעבמיפר CX,AX 
	PUSH	AX 
	MOV	CH,AL			;CH <--- תבניףשקבוםשך גבךפ 
					;(ףפבעיך גיפ ניופףס נועקשם) 
	MOV	CL,8			;הלס 8 גיפ הבממשט ק גבךפו. 
					;נעי ‏פומיי הקב נועונבהב ףיחמבלב 
W27:					;ןנעוהולסאפ ןהימ גיפ 
	RCL	CH,1			;CY <--- ףפבעיך גיפ 
	PUSHF				;ףןמעבמיפר זלבחי 
					;הלס תבניףי גיפ נועוהבופףס ק CY 
	CALL	WRITE_BIT		;תבניףבפר גיפ הבממשט 
	POPF				;קןףףפבמןקיפר CY הלס קש‏יףלומיס CRC 
	CALL	CRC_GEN	                ;קש‏יףליפר CRC הלס תבניףשקבוםןחן גיפב 
	DEC	CL			;DEC ף‏ופ‏יכ גיפ 
	JNZ	W27			;נןקפןעיפר, וףלי מו קףו גיפש תבניףבמש 
	POP	AX			;קןףףפבמןקיפר AX,CX 
	POP	CX 
	RET				;תבכןמ‏יפר תבניףר גבךפב 
WRITE_BYTE	ENDP 
;-------------------------------------------------------------------------- 
WRITE_BIT       PROC    NEAR 
; דולר: 
; 
; תבניףבפר גיפ הבממשט מב כבףףופץ 
; תבניףשקבוםשך גיפ נועוהבופףס ק CY 
; פ.ו. וףלי CY=1, תבניףשקבופףס גיפ "1", 
;      וףלי CY=0, תבניףשקבופףס גיפ "0" 
; 
; נעיםו‏במיו: גיפ תבניףשקבופףס הץםס נועונבהבםי ףיחמבלב(1 נועיןה) 
;       גיפ "1" יםוופ הליפולרמןףפר נןלץנועיןהב 500 םיכעןףוכץמה 
;        ( נועיןה - 1000 םיכעןףוכץמה ) 
; 
;       גיפ "0" יםוופ הליפולרמןףפר נןלץנועיןהב 250 םיכעןףוכץמה 
;        ( נועיןה - 500 םיכעןףוכץמה ) 
; 
;-------------------------------------------------------------------------- 
                                        ;נעוהנןלןצים, ‏פן '1' 
        MOV     AX,1184                 ;תבהבפר נועיןה "1" 
        JC      W28                     ;נועוךפי, וףלי תבניףשקבוםיך גיפ "1" 
        MOV     AX,592                  ;ימב‏ו ץףפבמןקיפר נועיןה "0" 
W28: 
        PUSH    AX                      ;ףןטעבמיפר AX 
W29: 
        IN      AL,PORT_C               ;‏יפבפר קשטןה כבמבלב 2 פבךםועב 
        AND     AL,020H 
        JZ      W29                     ;צהבפר נןסקלומיו קשףןכןחן ץעןקמס 
W30: 
        IN      AL,PORT_C               ;פונוער צהבפר נןכב פבךםוע נועוכלא‏יפףס 
					;ןגעבפמן ק מיתכיך ץעןקומר 
        AND     AL,020H 
        JNZ     W30 
                                        ;נועותבחעץתיפר כבמבל 2 פבךםועב 
                                        ;הלס נןלץ‏ומיס נועיןהב ףלוהץא‎וחן גיפב 
        POP     AX                      ;קןףףפבמןקייפר כןזזידיומפ הולומיס 
W31:                                    ;נעןחעבםםיעןקבמיו פבךםועב 
        OUT     042H,AL                 ;תבניףבפר םלבהיך גבךפ ק כבמבל 2 
        MOV     AL,AH 
        OUT     042H,AL                 ;תבניףבפר ףפבעיך גבךפ ק כבמבל 2 
        RET 
WRITE_BIT       ENDP 
 
;------------------------------------------------------------------------ 
CRC_GEN PROC    NEAR 
; חומועיעץופ CRC הלס תבניףשקבוםןחן גיפב 
; 
; CRC יףנןלרתץופףס הלס ןגמבעץצומיס ןיגןכ ‏פומיס 
; 
; ק CY נועוהבופףס גיפ מב כןפןעשך חומועיעץופףס CRC 
; 
; םןהיזידיעץופ AX י זלבחי 
; 
;------------------------------------------------------------------------- 
        MOV     AX,CRC_REG 
                                        ;נןףלוהץא‎יו ימףפעץכדיי 
                                        ;ץףפבמבקליקבאפ זלבח זלבח נועונןלמומיס, 
                                        ;וףלי CY י ףפבעיך גיפ CRC מו עבקמש 
        RCR     AX,1 
        RCL     AX,1 
        CLC                             ;ןגמץליפר CY 
        JNO     W32                     ;נועוךפי, וףלי נועונןמומיו 
                                        ;וףלי גיפ הבממשט XOR ף 15 עבתעסהןם 
                                        ;CRC עוחיףפעב = 1, 
        XOR     AX,0810H                ;פן קשנןלמיפר XOR CRC עוחיףפעב ף 
                                        ;0810H 
        STC                             ;ץףפבמןקיפר CY 
W32: 
        RCL     AX,1                    ;ףהקימץפר CY (גיפ הבממשט) 
                                        ;ק CRC עוחיףפע 
        MOV     CRC_REG,AX              ;ףןטעבמיפר CRC 
        RET                             ;תבכןמ‏יפר 
CRC_GEN ENDP 
 
