;---INT 15-----------------------------------------------14-02-89-------------- 
; CASSETTE I/O 
;       (AH) = 0 χλμΰώιτψ δχιηατεμψ (Χ ΔΑΞΞΟΚ ΧΕΣΙΙ 0 Ι 1 Ζ-ΓΙΙ 
;       (AH) = 1 χωλμΰώιτψ δχιηατεμψ   ΟΤΣΥΤΣΤΧΥΐΤ) 
;       (AH) = 2 ώιτ. 1 ιμι βομψϋε 256-βακτξωθ βμολοχ σ λασσετω 
;               (ES,BX) = αδςεσ βυζεςα δαξξωθ 
;               (CX) = λομιώεστχο βακτ δμρ ώτεξιρ 
;               ξα χωθοδε: 
;               (ES,BX) = αδςεσ ποσμεδξεηο σώιτ. βακτα + 1 
;               (DX) = λομιώεστχο σώιταξξωθ βακτ 
;               (CY) = 0 εσμι ξετ οϋιβολ πςι ώτεξιι 
;                    = 1 οβξαςυφεξα οϋιβλα ώτεξιρ 
;               (AH) = χοϊχςαύαενωκ λοδ οϋιβλι, εσμι (CY)=1 
;                       =01 οϋιβλα CRC λοξτςομρ 
;                       =02 ποτεςρ δαξξωθ 
;                       =04 τακναυτ πςι ποισλε ζακμα 
;       (AH) = 3 πισατψ 1 ιμι βομψϋε 256-βακτξωθ βμολα ξα λασσετυ 
;               (ES,BX) = αδςεσ ψυζεςα δαξξωθ 
;               (CX) = λομιώεστχο βακτ δμρ ϊαπισι 
;               ξα χωθοδε: 
;               (EX,BX) = αδςεσ ποσμεδξεηο ϊαπισαξξοηο βακτα + 1 
;               (CX) = 0 
;       (AH) = 4 ώτεξιε ζακμα σ λασσετω 
;              DS:[BX] - αδςεσ σινχομψξοκ στςολι, σοδεςφαύεκ ινρ ζακμα 
;              (ES) - αδςεσ βυζεςα δαξξωθ 
;              ξα χωθοδε: 
;              (AH) - χοϊχςαύαενωκ λοδ οϋιβλι, εσμι (CY) = 1 
;                       =01 οϋιβλα CRC λοξτςομρ 
;                       =02 ποτεςρ δαξξωθ 
;                       =04 τακναυτ πςι ποισλε ζακμα 
;       (AH) = 5 ϊαπισψ ζακμα ξα λασσετυ 
;              DS:[BX] - αδςεσ σινχομψξοκ στςολι, σοδεςφαύεκ ινρ ζακμα 
;              (ES) - αδςεσ βυζεςα δαξξωθ 
;              ξα χωθοδε: 
;              (CY) = 1 - οϋιβλα ώτεξιρ 
;       (AH) = δςυηοε ϊξαώεξιε - (CY)=1 - ξεσυύεστχυΰύαρ οπεςαγιρ, 
;              χοϊχςαύαετ (AH) = 80 - πςιϊξαλ ξεσυύεστχυΰύεκ οπεςαγιι. 
;--------------------------------------------------------------------------- 
; 
CASSETTE_IO     PROC        FAR 
        CLI                     ;ϊαπςετιτψ πςεςωχαξιρ 
        PUSH    DS 
        PUSH    AX 
	MOV	AX,DATA 
	MOV	DS,AX 
        POP     AX 
        CALL    W1              ;χωϊχατψ δισπετώες ζυξλγικ 
        POP     DS 
        STI                     ;ςαϊςεϋιτψ πςεςωχαξιρ 
        RET     2               ;χοϊχςατ 
CASSETTE_IO     ENDP 
W1      PROC NEAR 
;-----------------------------------------------------------14-02-89-------- 
; γεμψ: 
;  χωϊοχ ζυξλγιι σοημασξο σοδεςφινονυ ςεηιστςα AH 
; 
;  AH           ζυξλγιρ 
;----------------------------------------------------------------------------- 
;  0            χλμ. δχιηατεμψ 
;  1            χωλμ. δχιηατεμψ 
;  2            ώτεξιε βμολα 
;  3            ϊαπισψ βμολα 
;  4            ώτεξιε ζακμα 
;  5            ϊαπισψ ζακμα 
;------------------------------------------------------------------------------ 
 
        OR      AH,AH 
        JNZ     WK1 
        RET 
WK1:    DEC     AH 
        JNZ     WK2 
        RET 
WK2:    DEC     AH                      ;ώτεξιε? 
        JZ      READ_BLOCK              ;δα 
        DEC     AH                      ;ϊαπισψ? 
        JNZ     W2                      ;ξετ 
        JMP     WRITE_BLOCK             ;δα, ϊαπισψ 
 
W2: 
        DEC     AH 
        JNZ     W201 
        JMP     FILE_READ               ;ώτεξιε ζακμα 
W201:   DEC     AH 
        JNZ     W202 
        JMP     FILE_WRITE              ;ϊαπισψ ζακμα 
W202: 
                                        ;ξεσυύεστχυΰύαρ ζυξλγιρ 
        MOV     AH,080H                 ;υσταξοχιτψ λοδ χοϊχςατα 
        STC                             ;υσταξοχιτψ ζμαη οϋιβλι 
        RET 
W1      ENDP 
 
READ_BLOCK      PROC    NEAR 
;----------------------------------------------------------------------------- 
; γεμψ: 
;   ώιτατψ 1 ιμι βομψϋε 256-βακτξωθ βμολοχ σ λασσετω 
; 
; χθοδξωε παςανετςω: 
;   ES σεηνεξτ βυζεςα δμρ πςιενα δαξξωθ 
;   BX υλαϊατεμψ ξαώαμα βυζεςα 
;   CX υλαϊωχαετ λομιώεστχο βακτ λοτοςωε ξεοβθοδινο πςοώεστψ 
; χωθοδξωε παςανετςω: 
;   BX υλαϊωχαετ αδςεσ βακτα σμεδυΰύεηο ϊα ποσμεδξιν σώιταξξων 
;   CX χωώιταΰύικ σώετιλ σώιτωχαενωθ βακτ 
;   DX σώετώιλ πςοώιταξξωθ βακτ 
; 
; ζμαη πεςεξοσα ςαχεξ ξυμΰ, εσμι ξετ οϋιβολ 
; ι υσταξαχμιχαετσρ πςι οβξαςυφεξιι οϋιβλι 
;---------------------------------------------------------------------------- 
        PUSH    BX                      ;σοθςαξιτψ BX 
        PUSH    CX                      ;σοθςαξιτψ CX 
        PUSH    SI                      ;σοθςαξιτψ SI 
        MOV     SI,7                    ;ώισμο ποπωτολ ποισλα ϊαηομοχλα 
W4:                                     ;ποισλ ϊαηομοχλα 
        IN      AL,PORT_C               ;σώιτατψ ποςτ οβνεξα σ λασσετξ. 
        AND     AL,010H ;χωδεμιτψ σιηξαμψξωκ ςαϊςρδ 
        MOV     LAST_VAL,AL             ;σοθςαξιτψ ϊξαώεξιε υςοχξρ σιηξαμα 
        MOV     DX,16250                ;ώισμο γιλμοχ δμρ οφιδαξιρ πεςεπαδα 
W5:                                     ;υςοχξρ σιηξαμα 
        CALL    BREAK_TEST              ;πςεςχατψ σώιτωχαξιε? 
        JNZ     W6                      ;ξετ 
        JMP     W17                     ;πςεςχατψ ώτεξιε 
 
W6:     DEC     DX 
        JNZ     W7                      ;πεςεθοδ, εσμι ξαώαμο ϊαηομοχλα 
        JMP     W17                     ;πεςεθοδ, εσμι ϊαηομοχολ ξε ξακδεξ 
 
W7:     CALL    READ_HALF_BIT           ;ιηξοςιςοχατψ πεςχωκ ινπυμψσ 
        JCXZ    W5                      ;πεςεκτι εσμι ξε βωμο πεςεπαδα σιηξ. 
        IN      AL,021H ;πςοώιτατψ ςεη. νασλι πςεςωχαξικ 
        OR      AL,1                    ;ϊαπςετιτψ πςεςωχαξιρ οτ τακνεςα 
        OUT     021H,AL 
; 
        CALL    READ_HALF_BIT           ;πομυώιτψ δμιτεμψξοστψ π/πεςιοδα 
        JCXZ    W4                      ;τακναυτ 
        MOV     DX,BX                   ;σοθςαξιτψ πομυώ. δμιτ. 
	CALL	READ_HALF_BIT		;πομυώιτψ δμιτ. 2-ηο π/πεςιοδα 
	JCXZ	W4			;τακναυτ 
	ADD	BX,DX			;πομυώιτψ δμιτ. πεςιοδα 
 
;  -----------   γιλμ δμρ ςασποϊξαχαξιρ ϊαηομοχλα 
 
	MOV	CX,100H	 ;σώετώιλ βακτοχ δμρ ιδεξτιζιλαγιι 
W8: 
	CALL	BREAK_TEST		;πςεςχατψ? 
        JNZ     W117                    ;ξετ 
        JMP     W17                     ;δα 
W117:   XCHG    DX,BX                   ;σοθςαξιτψ δμιτ. πςεδωδυύ. πεςιοδα 
        PUSH    CX 
; ----------------------------  πομυώιτψ δμιτεμψξοστψ ξοχοηο πεςιοδα 
	CALL	READ_HALF_BIT		;πομυώιτψ δμιτεμψξοστψ π/πεςιοδα 
        OR      CX,CX 
        POP     CX 
        JZ      W4 
        PUSH    CX 
	PUSH	BX			;σοθςαξιτψ πομυώ.δμιτ. π/πεςιοδα 
        CALL    READ_HALF_BIT           ;πομυώιτψ ξοχυΰ δμιτ. 
        OR      CX,CX 
	POP	AX			;χ AX χοσσταξοχιτψ πςεδωδυύ. δμιτ. 
        POP     CX 
        JZ      W4 
	ADD	BX,AX			;BX <--- δμιτ. ξοχοηο πεςιοδα 
	SUB	DX,BX			;σςαχξιτψ δμιτ. ξοχοηο ι πςεδωδυύ.πες. 
	JNC	W801			;εσμι ςαϊξιγα οτςιγατεμψξα, 
	NEG	DX			;πομυώιτψ αβσομΰτξοε ϊξαώεξιε 
W801:	CMP	DX,0C0H ;πςοχεςιτψ ξα δοπυστινυΰ ςαϊξιγυ 
					;πςεδωδυύικ ι ξοχωκ πεςιοδ 
	JNC	W4			;ςαϊξιγα βομψϋε δοπυστινοκ 
 
	LOOP	W8			;ποχτοςιτψ, εσμι πςοαξαμιϊιςχαξο 
					;νεξψϋε 256 (100H) πεςιοδοχ 
 
;--- εσμι ξαώαμο ϊαηομοχλα οποϊξαξο, χωώισμιτψ σςεδξΰΰ δμιτεμψξοστψ 
;    πεςιοδα βιτοχ "1" ι νιξιναμψξο-δοπυστινυΰ δμιτ. "1" 
 
        XCHG    DX,BX 
        MOV     CX,0FFH ;υσταξοχιτψ σώετώιλ 
        XOR     AX,AX                   ;οβξυμιτψ συννατος οτλμοξεξικ 
W88:    PUSH    CX                      ;σοθςαξιτψ σώετώιλ 
        PUSH    AX                      ;σοθςαξιτψ συννυ οτλμοξεξικ 
        CALL    READ_HALF_BIT           ;πομυώιτψ δμιτεμψξοστψ πομυπεςιοδα 
        PUSH    BX                      ;σοθςαξιτψ πομυώ. δμιτ. 
        CALL    READ_HALF_BIT           ;πομυώιτψ δμιτ. 2-ηο πομυπεςιοδα 
        POP     AX                      ;χοσσταξοχιτψ πςεδωδυύυΰ δμιτ. 
        ADD     BX,AX                   ;πομυώιτψ δμιτεμψξοστψ πεςιοδα 
        POP     AX                      ;χοσσταξοχιτψ συννυ οτλμοξεξικ 
        SUB     BX,DX                   ;πομυώιτψ ξοχοε οτλμοξεξιε 
        ADD     AX,BX                   ;πςιβαχιτψ λ συννε 
        POP     CX                      ;χοσσταξοχιτψ σώετώιλ 
        LOOP    W88 
; 
        MOV     CL,8 
        SAR     AX,CL                   ;πομυώιτψ σςεδξεε οτλμοξεξιε 
        ADD     DX,AX                   ;DX <--- σςεδξεε ϊξαώ. πεςιοδα "1" P1 
        MOV     BX,DX 
        SAR     BX,1                    ;BX <--- P1/2 
        MOV     DX,BX 
        SAR     BX,1                    ;BX <--- P1/4 
        ADD     DX,BX                   ;DX <--- 0.75*P1 - MIN δοπ. ϊξαώ. πες 
        MOV     LOWLIM,DX               ;σοθς. MIN δοπ. ϊξαώ. πεςιοδα "1" 
        MOV     DX,BX 
        SAR     BX,1                    ;BX <--- P1/8 
        ADD     DX,BX                   ;DX <--- 3/8 * P1 - MIN δοπ. ϊξαώεξιε 
                                        ;πομυπεςιοδα "1" δμρ ποισλα σταςτ-βιτα 
; 
;                               ποισλ "0" - σταςτ-βιτα 
W89: 
        CALL    BREAK_TEST              ;πςεςχατψ ώτεξιε 
        JZ      W17                     ;δα 
        CALL    READ_HALF_BIT           ;πομυώιτψ δμιτ. πομυπεςιοδα σιηξαμα 
        CMP     DX,BX                   ;"0" ιμι "1"? 
        JC      W89                     ;εσμι "1" - ποχτοςιτψ 
; 
;   σταςτ-βιτ ξακδεξ. πςοχεςλα σιξθςοσινχομα: 
        CALL    READ_HALF_BIT           ;πςοπυστιτψ 2-κ πομυπεςιοδ σταςτ-βιτα 
        CALL    READ_BYTE               ;πςοώιτατψ σιξθςοβακτ 
        CMP     AL,16H                  ;πςοχεςιτψ σιξθςο-σινχομ 
        JNE     W16                     ;πεςεθοδ, εσμι πμοθοκ ϊαηομοχολ 
 
;------ϊαηομοχολ πςοώιταξ υσπεϋξο. ώτεξιε βμολοχ δαξξωθ 
        POP     SI                      ;χοσσταξοχιτψ ςεηιστςω 
        POP     CX 
        POP     BX 
 
;------------------------------------------------------------------------- 
; ώιτατψ 1 ιμι βομψϋε 256-βακτξωθ βμολοχ δαξξωθ σ λασσετω 
; 
;ξα χθοδε: 
; ES - σεηνεξτ δμρ βυζεςα χ πανρτι δμρ πςιενα σώιταξξωθ βακτ 
; BX - υλαϊατεμψ αδςεσα χ βυζεςε 
; CX - σοδεςφιτ λομιώεστχο βακτ λοτοςωε ξεοβθοδινο πςοώιτατψ 
;ξα χωθοδε: 
; BX - υλαϊωχαετ αδςεσ βακα χ βυζεςε, σμεδυΰύεηο ϊα ποσμεδξιν πςώιταξξων 
; CX - χωώιταΰύικ σετώιλ σώιτωχαενωθ βακτ 
; DX - σοδεςφιτ λομιώεστχο πςοώιταξξωθ βακτ 
;--------------------------------------------------------------------------- 
        PUSH    CX                      ;σοςαξιτψ σώετώιλ βακτ 
W10:                                    ;τοώλα χθοδα δμρ χοϊχςατα 
                                        ;πο πςοώτεξιΰ 256-βακτξοηο βμολα 
        MOV     CRC_REG,0FFFFH          ;ιξιγιαμιϊιςοχατψ CRC-ςεηιστς 
        MOV     DX,256                  ;DX <--- ςαϊνες βμολα δαξξωθ 
W11:                                    ;ώιτατψ βμολ 
        CALL    BREAK_TEST              ;πςεςχατψ ώτεξιε? 
        JZ      W13                     ;δα 
        CALL    READ_BYTE               ;σώιτατψ βακτ 
        JC      W13                     ;εσμι οϋιβλα - CY=1 
        JCXZ    W12                     ;εσμι πςοώιταξω χσε βακτω (CX), 
                                        ;δοώιτατψ βμολ, ξο χ βυζεςε 
                                        ;ξε σοθςαξρτψ 
        MOV     ES:[BX],AL              ;σοθςαξιτψ βακτ χ βυζεςε 
        INC     BX                      ;υχεμιώιτψ αδςεσ βυζεςα 
        DEC     CX                      ;υνεξψϋιτψ σώετώιλ βακτ 
W12:                    ;ϊαχεςϋεξιε γιλμα ώτεξιρ 256-βακτξοηο βμολα δαξξωθ 
        DEC     DX                      ;υνεξψϋιτψ σώετώιλ βακτ χ βμολε 
        JG      W11                     ;χοϊχςατ ξα ώτεξιε, εσμι < 256 
        CALL    READ_BYTE               ;τεπεςψ ώιταεν δχα βακτα CRC 
        CALL    READ_BYTE 
        SUB     AH,AH                   ;οβξυμρεν AH 
        CMP     CRC_REG,1D0FH           ;CRC πςαχιμψξο? 
        JNE     W14                     ;πεςεκτι, εσμι οϋιβλα 
        JCXZ    W15                     ;εσμι σώετώιλ βακτ=0, τ.ε. 
                                        ;πςοώιταξω χσε δαξξωε, 
                                        ;ϊαχεςϋιτψ ώτεξιε 
        JMP     W10                     ;εσμι ξετ - ώιτατψ σμεδυΰύικ βμολ 
                                ;οβςαβοτλα οϋιβολ ώτεξιρ 
W13:                                    ;ποτεςρξω δαξξωε 
        MOV     AH,01H                  ;υσταξοχιτψ λοδ χοϊχςατα AH=02 - 
                                        ;"ποτεςρξω δαξξωε" 
W14:                                    ;οϋιβλα CRC-λοξτςομρ 
        INC     AH                      ;υσταξοχιτψ λοδ χοϊχςατα AH=01 - 
                                        ;"οϋιβλα CRC-λοξτςομρ" 
W15:                                    ;ϊαχεςϋεξιε ώτεξιρ 
        POP     DX                      ;χωώισμιτψ ώισμο ςεαμψξο 
        SUB     DX,CX                   ;πςοώιταξξωθ βακτ 
                                        ;δμρ χοϊχςατα χ ςεη. DX 
        PUSH    AX                      ;σοθςαξιτψ AX (λοδ χοϊχςατα) 
        TEST    AH,03H                  ;εστψ οϋιβλι? 
        JNZ     W18                     ;χωθοδ πο οϋιβλε 
        CALL    READ_BYTE               ;πςοώιτατψ λοξεγ 
        JMP     SHORT W18               ;χωπομξιτψ χωλμΰώεξιε δχιηατεμρ 
W16:                                    ;πμοθοκ ϊαηομοχολ 
        DEC     SI                      ;πςοχεςιτψ ώισμο ποπωτολ ποχτοςα 
                                        ;ςασποϊξατψ ϊαηομοχολ 
        JZ      W17                     ;ώισμο ποπωτολ βομψϋε δοπυστινοηο 
        JMP     W4                      ;ποπωτατψσρ εύε ςαϊ 
W17:                                    ;ξε ξακδεξω δαξξωε 
;-------ξε ξακδεξω δαξξωε ξα λασσετε,τ.ε. τακναυτ πςι ώτεξιι 
 
        POP     SI                      ;χοσσταξοχιτψ ςεηιστςω 
        POP     CX 
        POP     BX 
        SUB     DX,DX                   ;ξυμψ βακτοχ πςοώιταξο 
        MOV     AH,04H                  ;οϋιβλα "τακναυτ πςι ώτεξιι" 
        PUSH    AX 
W18: 
        IN      AL,021H         ;πεςεςαϊςεϋιτψ πςεςωχαξιρ 
        AND     AL,0FFH-1 
        OUT     021H,AL 
        POP     AX                      ;χοσσταξοχιτψ λοδ χοϊχςατα 
        CMP     AH,01H                  ;υσταξοχιτψ CY=1 πςι οϋιβλε (AH>0) 
        CMC 
        RET                             ;ϊαλοξώιτψ 
READ_BLOCK      ENDP 
;--------------------------------------------------------------------------- 
READ_BYTE       PROC NEAR 
; γεμψ: 
;  πςοώιτατψ βακτ σ λασσετω 
;  ξα χωθοδε ςεηιστς AL σοδεςφιτ πςοιταξξωκ βακτ δαξξωθ 
;--------------------------------------------------------------------------- 
        PUSH    BX                      ;σοθςαξιτψ ςεηιστςω BX,CX 
        PUSH    CX 
        MOV     CL,8H                   ;υσταξοχιτψ σώετώιλ βιτ ςαχξων 8 
W19:                                    ;ώιτατψ βακτ 
        PUSH    CX                      ;σοθςαξιτψ σώετώιλ βιτ 
 
;---------------------------------------------------------------------------- 
;  ώιτατψ βιτ δαξξωθ σ λασσετω 
;---------------------------------------------------------------------------- 
        CALL    READ_HALF_BIT           ;πςοώιτατψ οδιξ πομυπεςιοδ 
        JCXZ    W21                     ;εσμι CX=0 - ινπυμψσ-τακναυτ 
                                        ;ξετ ϊαδεηο ζςοξτα ινπυμψσα 
        PUSH    BX                      ;σοθςαξιτψ δμιτεμψξοστψ 
                                        ;πομυπεςιοδα (IN BX) 
        CALL    READ_HALF_BIT           ;πςοώιτατψ χτοςοκ πομυπεςιοδ 
        POP     AX                      ;χοσσταξοχιτψ δμιτ. πςεδωδυύ. ινπ. 
        JCXZ    W21                     ;εσμι CX=0 - ινπυμψσ-τακναυτ 
        ADD     BX,AX                   ;χωώισμιτψ δμιξυ πεςιοδα 
        CMP     BX,LOWLIM               ;πςοχεςιτψ "0" ιμι "1" 
        CMC                             ;CY=1, εσμι εδιξιώξωκ βιτ 
        LAHF                            ;σοθςαξιτψ ζμαη πεςεξοσα χ AH 
        POP     CX                      ;χοσσταξοχιτψ σώετώιλ βιτ 
                                        ;δμρ σπςαχλι: 
                                        ;σταςϋικ βιτ ώιταετσρ πεςχων 
                                        ;ςεη. CH σδχιηαετσρ χμεχο ι 
                                        ;πεςεξοσ ϊαξοσιτσρ χ νμαδϋικ βιτ 
                                        ;ςεηιστςα CH. 
                                        ;ποσμε σώιτωχαξιρ χσεθ 8 βιτ 
                                        ;σταςϋικ βιτ σώιτωχαενοηο βακτα 
                                        ;ολαφετσρ χ σταςϋεν βιτε ςεη. CH 
        RCL     CH,1                    ;σδχιηαεν ςεη. CH χμεχο δμρ ϊαξεσεξιρ 
                                        ;πεςεξοσα χ νμαδϋικ βιτ ςεη. CH 
        SAHF                            ;χοσσταξαχμιχαεν CY δμρ χωώισμεξιρ CRC 
        CALL    CRC_GEN         ;ηεξεςιςυεν CRC δμρ σώιταξξοηο βιτα 
        DEC     CL                      ;υνεξψϋαεν σώετώιλ βιτ 
                                        ;ποχτοςρεν ώτεξιε βιτα πολα ξε πςοώι- 
        JNZ     W19                     ;ταεν χσε 8. 
        MOV     AL,CH                   ;AL <--- πςοώιταξξωκ βακτ 
        CLC 
W20:                                    ;ϊαχεςϋιτψ ώτεξιε βακτα 
        POP     CX                      ;χοσσταξοχιτψ ςεη. CX,BX 
        POP     BX 
        RET                             ;ϊαλοξώιτψ 
W21:                                    ;ποτεςρ δαξξωθ 
        POP     CX                      ;χοσσταξοχιτψ CX 
        STC                             ;υσταξοχιτψ ζμαη οϋιβλι 
        JMP     W20                     ;ϊαχεςϋιτψ ώτεξιε 
READ_BYTE       ENDP 
 
;-------------------------------------------------------------------------- 
WRITE_BLOCK     PROC    NEAR 
; 
; ϊαπισψ 1 ιμι βομψϋε 256-βακτξωθ βμολοχ ξα λασσετυ. 
;       χ ποσμεδξεν βμολε δαξξωε δοπομξρΰτσρ ποσμεδξιν βακτον δο δμιξω 256. 
; 
; χθοδξωε παςανετςω: 
;  BX - υλαϊατεμψ αδςεσα βυζεςα δαξξωθ 
;  CX - λομιώεστχο βακτ δμρ ϊαπισι 
; 
; ξα χωθοδε: 
;  BX υλαϊωχαετ αδςεσ βακτα, λοτοςωκ σμεδυετ ϊα ποσμεδξιν ϊαπισαξξων 
;  CX ςαχεξ ξυμΰ 
;--------------------------------------------------------------------------- 
        PUSH    BX 
        PUSH    CX 
        IN      AL,PORT_B               ;χωλμΰώιτψ ηςονλοηοχοςιτεμψ 
        AND     AL,NOT 02H 
        OR      AL,01H                  ;ςαϊςεϋιτψ σώετ 2 λαξαμα τακνεςα 
        OUT     PORT_B,AL 
        MOV     AL,0B6H          ;λαξαμ 2 τακνεςα χ ςεφιν 3 
        OUT     TIM_CTL,AL 
        MOV     AX,1184  ;λοόζ. δεμεξιρ δμρ ώαστοτω "1" 
        CALL    W31                     ;ϊαηςυϊιτψ τακνες 
        MOV     CX,0800H                ;σώετώιλ χιτοχ δμρ ϊαηομοχλα 
W23:                                    ;ϊαπισατψ ϊαηομοχολ 
        STC                             ;ϊαπισατψ βιτ "1" 
        CALL    WRITE_BIT               ; 
        LOOP    W23                     ;ϊαπισαξ χεσψ ϊαηομοχολ? 
        CLC                             ;ϊαπισατψ σιξςο-βιτ (0) 
        CALL    WRITE_BIT 
        POP     CX                      ;χοσσταξοχιτψ CX,BX 
        POP     BX 
        MOV     AL,16H                  ;ϊαπισατψ σιξθςο-σινχομ 
        CALL    WRITE_BYTE              ; 
 
;------------------------------------------------------------------------- 
; ϊαπισατψ 1 ιμι βομψϋε 256-βιτξωθ βμολοχ ξα λασσετυ. 
; 
; χθοδξωε παςανετςω: 
;  BX - υλαϊατεμψ αδςεσα βυζεςα δαξξωθ 
;  CX - λομιώεστχο βακτ δμρ ϊαπισι 
; 
; ξα χωθοδε: 
;  BX υλαϊωχαετ αδςεσ βακτα, λοτοςωκ σμεδυετ ϊα ποσμεδξιν ϊαπισαξξων 
;  CX ςαχεξ ξυμΰ 
; 
;--------------------------------------------------------------------------- 
WR_BLOCK: 
        MOV     CRC_REG,0FFFFH          ;ιξιγιαμιϊιςοχατψ CRC-ςεηιστς 
        MOV     DX,256                  ;σώετώιλ βακτ χ βμολε 
W24:                                    ;WR-BLK 
        MOV     AL,ES:[BX]              ;πςοώιτατψ βακτ ιϊ πανρτι 
        CALL    WRITE_BYTE              ;ϊαπισατψ εηο ξα λασσετυ 
        JCXZ    W25                     ;εσμι CX=0,ξε ιϊνεξρτψ σώετώιλ ιυλαϊατ. 
        INC     BX                      ;INC υλαϊατεμψ αδςεσα βυζεςα 
        DEC     CX                      ;DEC σώετώιλ ϊαπισωχενωθ βακτ 
W25:                                    ;SKIP-ADV 
        DEC     DX                      ;DEC σώετώιλ βακτ βμολα 
        JG      W24                     ;ϊαπισαξω χσε 256 βακτ δαξξοηο βμολα? 
 
;----------------------ϊαπισατψ CRC------------------------------------------- 
; ϊαπισατψ οβςατξωκ λοδ CRC-ςεηιστςα ξα λασσετυ. 
; πςι σώιτωχαξιι βμολα πςοχεςρετσρ σοοτχετστχιε χωώισμεξξοηο ι σώιταξξοηο CRC 
; 
; νοδιζιγιςυετ ςεηιστς AX 
;----------------------------------------------------------------------------- 
        MOV     AX,CRC_REG              ;ϊαπισατψ οβςατξωκ λοδ CRC-ςεηιστςα 
                                        ;χ χιδε δχυθ βακτοχ CRC ξα λασσετυ 
        NOT     AX                      ;πομυώιτψ οβςατξωκ λοδ 
        PUSH    AX                      ;σοθςαξιτψ εηο 
        XCHG    AH,AL                   ;σταςϋικ βακτ ϊαπισωχαετσρ πεςχων 
        CALL    WRITE_BYTE              ;ϊαπισατψ εηο 
        POP     AX                      ;χοσσταξοχιτψ νμαδϋικ βακτ 
        CALL    WRITE_BYTE              ;ϊαπισατψ εηο 
        OR      CX,CX                   ;χσε βακτω ϊαπισαξω? 
        JNZ     WR_BLOCK                ;εσμι ξετ πςοδομφιτψ 
        PUSH    CX                      ;σοθςαξιτψ CX 
        MOV     CX,32                   ;ϊαπισατψ λοξεγ ζακμα 
W26:                                    ;γιλμ ϊαπισι λοξγα ζακμα 
        STC 
        CALL    WRITE_BIT 
        LOOP    W26                     ;πισατψ πολα ισώεςπαετσρ σώετώιλ 
        POP     CX                      ;χοσσταξοχιτψ CX 
	MOV	AL,0B0H		;χοσσταξοχιτψ ςεφιν τακνεςα 
        OUT     TIM_CTL,AL 
        MOV     AX,1 
        CALL    W31 
        IN      AL,PORT_B 
        AND     AL,NOT 01H 
        OUT     PORT_B,AL 
        SUB     AX,AX                   ;ξετ οϋιβολ ϊαπισι 
        RET                             ;ϊαλοξώιτψ 
WRITE_BLOCK     ENDP 
 
 
                ORG     0FA6EH 
 
